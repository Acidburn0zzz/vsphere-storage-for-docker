<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="cna-storage@vmware.com">
  
  <title>Admin CLI - Docker Volume Driver for vSphere</title>
  

  <link rel="shortcut icon" href="../../favicon.ico">
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Admin CLI";
    var mkdocs_page_input_path = "user-guide/vmdkops-admin-cli-spec.md";
    var mkdocs_page_url = "/user-guide/vmdkops-admin-cli-spec/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script>
  <script src="../../js/theme.js"></script> 

  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-81413942-1', 'vmware.github.io/docker-volume-vsphere');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Docker Volume Driver for vSphere</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../..">Home</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Features</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../features/vcenter/">Integration with vCenter</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../features/vsan-policy/">VSAN Policy</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Documentation</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../install/">Installation and Deployment</a>
        
    </li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">Admin CLI</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#ls">ls</a></li>
                
            
                <li class="toctree-l3"><a href="#policy">policy</a></li>
                
            
                <li class="toctree-l3"><a href="#role">role</a></li>
                
            
                <li class="toctree-l3"><a href="#status">Status</a></li>
                
            
                <li class="toctree-l3"><a href="#help">help</a></li>
                
            
            </ul>
        
    </li>

        
            
    <ul class="subnav">
    <li><span>Docker Volume CLI</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../docker-volume-cli/">Basic commands</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../datastores/">Multiple Datastores</a>
        
    </li>

        
    </ul>

        
            
    <ul class="subnav">
    <li><span>Backend ESX Overview</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../esx-overview/">Volume Layout</a>
        
    </li>

        
    </ul>

        
    </ul>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../faq/">FAQ</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Blog</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../blog/storage-availability/">Docker Volume and Storage Availability</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Docker Volume Driver for vSphere</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Documentation &raquo;</li>
        
      
    
    <li>Admin CLI</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <div class="toc">
<ul>
<li><a href="#ls">ls</a></li>
<li><a href="#policy">policy</a></li>
<li><a href="#role">role</a></li>
<li><a href="#status">Status</a></li>
<li><a href="#help">help</a></li>
</ul>
</div>
<p>In order to manage the inventory of VMDKs created and used by multiple docker engines we must have
an administrative CLI that lives on ESX. This administrative CLI can provide additional status such
as access control, storage policies, and disk usage and capacity.</p>
<p>The admin cli itself is non-interactive. All commands are of the form <code>vmdkops-admin &lt;Cmd&gt; [Arg1, Arg2,...]</code></p>
<p>All output from the admin cli defaults to human readable formats. It will be made easily grepable.</p>
<p>The majority of testing will be automated. We can ensure that parsing calls the right callbacks with
the right information by generating representative input and mocking the callbacks to assert that
the right information is parsed and delivered correctly. Additionally, and specifically for testing
roles, we can create roles and then test that they act as expected by calling <code>role get</code>. Unit
tests for stateless logic can be fed mock input representing data from sidecar and the filesystem.
These techniques should be sufficient enough to provide confidence in the implementation.</p>
<p>The rest of this specification will detail the commands to be implemented in the admin cli. Note
that the commands covered in this document only operate on a single ESX host.</p>
<h1 id="ls">ls<a class="headerlink" href="#ls" title="Permanent link">&para;</a></h1>
<p>List all volumes by reading the <code>dockvols</code> directories and metadata stored in Sidecar files.
Volumes in all datastores will be shown with the volume name in the first column and the datastore
in the second.</p>
<p><code>ls</code> supports the following options:
  * No options - List the names of all volumes
  * <code>ls -l</code> - List all volumes and their corresponding metadata. Note that missing metadata will be
    marked <code>N/A</code>.
    * Created by (VM Name)
    * Creation Time
    * Last Attached Time
    * Datastore
    * Policy Name
    * Capacity
    * Used Space
    * Attached To (VM Name)
  * <code>ls -c [Column1, Column2, ...]</code> - List only the columns specified, implies <code>-l</code>
  * <code>ls -f &lt;ColumnName Pattern Value&gt;</code> - Filter output by only including volumes whose columns match the
                                         sort pattern (See below). Note that the priority is P2 on
                                         this and it may be developed after the initial release
                                         depending on timing/effort.</p>
<p>Sort patterns are used for filtering. The argument, <code>X</code>, itself is of a type specific to the attribute. All dates are given in <a href="https://en.wikipedia.org/wiki/ISO_8601">ISO 8601 format</a></p>
<ul>
<li><code>&gt; X</code> The attribute is greater than X</li>
<li><code>&lt; X</code> The attribute is equal to X</li>
<li><code>= X</code> The attribute matches a Glob X</li>
</ul>
<p>Examples:</p>
<pre><code>vmdkops-admin ls -c CreatedBy,CreationTime,Datastore,PolicyName
vmdkops-admin ls -f 'LastAttachedTime &gt; 2016-03-11'
vmdkops-admin ls -f 'AttachedTo = Test*'
</code></pre>

<h1 id="policy">policy<a class="headerlink" href="#policy" title="Permanent link">&para;</a></h1>
<p>Create, configure and show the VSAN policy names and their corresponding VSAN policies. Also show whether or not they are in use.</p>
<p>Examples:
 * <code>vmdkops-admin policy create --name=myPolicy --content="string"</code> - Create a new policy
 * <code>vmdkops-admin policy rm myPolicy</code> - Remove the given policy
 * <code>vmdkops-admin policy ls</code> - List policies and the Volumes that are using that policy.
 * <code>vmdkops-admin policy update --name=myPolicy --content="string"</code> - Update an existing VSAN policy and
   any volumes currently using that policy</p>
<p>Note that on volume creation from docker, a policy name will be passed with a <code>-o</code> option.</p>
<h1 id="role">role<a class="headerlink" href="#role" title="Permanent link">&para;</a></h1>
<p>Create, delete, configure and show access control settings. Access control settings are assigned via a
VM naming convention, although a specific convention is not required. An example will help clarify
this. Let&rsquo;s say that an administrator wants to allow any <code>Test</code> VM to create, delete and mount
volumes, and only allow creation of volumes of a maximum size of 2TB. The admin would first create a
<code>Test</code> role specifying these permissions, as well as a glob indicating the vm naming convention that
the role should be applied to. In this instance the permissions in the role <code>Test</code> will be applied to any VM with a
name ending in <code>Test</code>. Since the admin creates the VMs they can control the naming convention and
permissions in a straightforward manner.</p>
<p><code>vmdkops-admin role create --name=Test --matches-vm=\*Test --volume-maxsize=2TB --rights=create,delete,mount</code></p>
<p><code>role create</code> accepts the following options as shown in the prior example:
 * <code>--name=&lt;Name&gt;</code> - The name of the role to be created
 * <code>--matches-vm=&lt;Glob&gt;</code> - The glob that matches VM names where the role should be applied. This
                           flag may be applied multiple times, where a VM matching any of the globs would
                           apply.
 * <code>--rights=&lt;Perm1,Perm2,...&gt;</code> - The permissions granted to matching VMs. The list of applicable rights is:
   * <code>create</code> - Allow volume creation. If the <code>--volume-maxsize</code> parameter is given it applies to create, otherwise size is unlimited.
   * <code>rm</code> - Allow volume deletion
   * <code>mount</code> - Allow volume mounting</p>
<p>Currently the idea is to allow volume deletion and mounting of any volume if the rights are granted.
However it may make sense to limit these to specific volumes, perhaps via a glob match.</p>
<p>Note that the <code>--volume-maxsize</code> parameter is human readable and given in the following format: <code>MB | GB | TB</code>.</p>
<p>Besides <code>role create</code>, there are 4 other commands with regards to roles. Roles can be deleted with
<code>role rm</code> and listed with <code>role ls</code>. Listing of roles will show all roles and the VMs they apply
to. <code>role set</code> takes identical paramters to role create, except it will update an existing role
only. Finally, there needs to be a way to check permissions. This can be performed with the <code>role
get</code> command. <code>role get</code> takes a VM name and returns both a list of the rights granted to the VM and
the roles that the VM matches on separate lines.</p>
<p>Examples are provided below.</p>
<pre><code> vmdkops-admin role create --name=myrole --matches-vm=&quot;glob expression over vm names&quot; --volume-maxsize=2TB --rights=create,delete,mount
 vmdkops-admin role rm myrole
 vmdkops-admin role ls
 vmdkops-admin role set --name=myrole --matches-vm=&quot;glob expression over vm names&quot; --volume-maxsize=4TB --rights=create,mount
 vmdkops-admin role get &lt;VmName&gt;
</code></pre>

<p>Role information is stored in a flat file, for lack of a better solution. The format of the file
is JSON, but the schema is currently undefined. Permission checking will need to be performed at
runtime by the ESX service, using the information provided by <code>vmdkops-admin role get &lt;VmName&gt;</code>. It
does seem inefficient to call out to a separate command to perform the check, but this allows the
simplest implementation and isolation of admin information inside a single script.</p>
<h1 id="status">Status<a class="headerlink" href="#status" title="Permanent link">&para;</a></h1>
<p>Show any interesting information about the service. This includes file paths of config files, version
information, and PID of running service. A simple example is shown here, although it&rsquo;s possible
that the exact format may be somewhat different.</p>
<pre><code>[root@localhost:~] /usr/lib/vmware/vmdkops/bin/vmdkops_admin.py status
Version: 1.0.0-0.0.1
Status: Running
Pid: 73114
Port: 1019
LogConfigFile: /etc/vmware/vmdkops/log_config.json
LogFile: /var/log/vmware/vmdk_ops.log
LogLevel: INFO
</code></pre>

<h1 id="help">help<a class="headerlink" href="#help" title="Permanent link">&para;</a></h1>
<p>Show help as described in this doc.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../docker-volume-cli/" class="btn btn-neutral float-right" title="Basic commands">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../install/" class="btn btn-neutral" title="Installation and Deployment"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../install/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../docker-volume-cli/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
