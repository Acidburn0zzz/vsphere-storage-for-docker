<!DOCTYPE html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content=" ">
<title>Docker Volume Plugin Lifecycle. | vSphere Docker Volume Service</title>
<link rel="stylesheet" href="css/syntax.css">


<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<link rel="stylesheet" href="css/infracloudio-lavish-bootstrap.css">
<link rel="stylesheet" href="css/vmware-customstyles.css">
<link rel="stylesheet" href="css/infracloudio-theme-blue.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="" href="feed.xml">

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> vSphere Docker Volume Service</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- entries without drop-downs appear here -->
                
                
                
                <li><a href="index.html">Home</a></li>
                
                
                
                <li><a href="faq.html">FAQs</a></li>
                
                
                
                <li><a href="contactus.html">Contact Us</a></li>
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Downloads<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="https://store.docker.com/plugins/vsphere-docker-volume-service" target="_blank">Docker Plugin</a></li>
                        
                        
                        
                        <li><a href="https://bintray.com/vmware/vDVS/VIB/_latestVersion" target="_blank">VIB</a></li>
                        
                        
                        
                        <li><a href="https://bintray.com/vmware/vDVS/vDVS_RPM/_latestVersion" target="_blank">RPM</a></li>
                        
                        
                        
                        <li><a href="https://bintray.com/vmware/vDVS/vDVS_DEB/_latestVersion" target="_blank">DEB</a></li>
                        
                        
                    </ul>
                </li>
                
                
                
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Docker Volume Plugin Lifecycle.">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
    <div class="col-lg-12">&nbsp;</div>
    <!-- Content Row -->
    <div class="row">
        <!-- Sidebar Column -->
        <div class="col-md-3">

          












<ul id="mysidebar" class="nav">
    <li class="sidebarTitle">Menu </li>
    
    
    
    <li>
        <a href="#">Get Started</a>
        <ul>
            
            
            
            <li><a href="index.html">Introduction</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Setup</a>
        <ul>
            
            
            
            <li><a href="prerequisite.html">Prerequsites</a></li>
            
            
            
            
            
            
            <li><a href="install.html">Installation</a></li>
            
            
            
            
            
            
            <li><a href="configuration.html">Configuration</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">User Guide</a>
        <ul>
            
            
            
            <li><a href="docker-volume-cli.html">Docker Volume Management</a></li>
            
            
            
            
            
            
            <li><a href="vfile-plugin.html">vFile Volume Plugin for Docker</a></li>
            
            
            
            
            
            
            <li><a href="docker-compatibility.html">Docker Compatibility</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Admin Guide</a>
        <ul>
            
            
            
            <li><a href="datastores.html">Datastores Support</a></li>
            
            
            
            
            
            
            <li><a href="admin-cli.html">Admin CLI Reference</a></li>
            
            
            
            
            
            
            <li><a href="tenancy.html">Multi-tenancy Support</a></li>
            
            
            
            
            
            
            <li><a href="policy-based-management.html">Storage Policy Based Management</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Applications & Examples</a>
        <ul>
            
            
            
            <li><a href="demo-wordpress-app.html">Wordpress application with MariaDB</a></li>
            
            
            
            
            
            
            <li><a href="demo-ha-swarm.html">HA DB in Docker Swarm mode</a></li>
            
            
            
            
            
            
            <li><a href="docker-service.html">Running MongoDB (Docker Service) with vSphere volume</a></li>
            
            
            
            
            
            
            <li><a href="docker-stacks.html">Running an Example App with Docker Stacks</a></li>
            
            
            
            
            
            
            <li><a href="s3-object-storage.html">S3 Object storage with vDVS</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Miscellaneous</a>
        <ul>
            
            
            
            <li><a href="blogs.html">Blogs</a></li>
            
            
            
            
            
            
            <li><a href="known-issues.html">Known Issues</a></li>
            
            
            
            
        </ul>
        
        
        
        <!-- if you aren't using the accordion, uncomment this block:
           <p class="external">
               <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
           </p>
           -->
    </li>
</ul>
</div>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

    <!-- Content Column -->
    <div class="col-md-9">
        <div class="post-header">
   <h1 class="post-title-main">Docker Volume Plugin Lifecycle.</h1>
</div>



<div class="post-content">

   

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 10);
  return false
})
  
});
</script>

<div id="toc"></div>

    


    

    <a target="_blank" href="https://github.com/vmware/docker-volume-vsphere/edit/gh-pages/jekyll-docs//plugin-lifecycle.md" class="btn btn-default githubEditButton" role="button"><i class="fa fa-github fa-lg"></i> Edit me</a>

    

  <h1 id="docker-volume-plugin-lifecycle">Docker Volume Plugin Lifecycle.</h1>

<p>This document is designed to be a comprehensive document capturing the plugin lifecycle and its implications to volume mangement.
This is meant to help customers and other developers understand the rationale for the various decisions made by the plugin.</p>

<h1 id="plugin-lifecycle-and-impact-on-volume-refcount">Plugin Lifecycle and impact on volume refcount.</h1>

<p>The docker volume plugin is not actively managed by docker. The lifcycle of the plugin exists independent of the lifecycle of docker. There is a requirement within the plugin to track and remember the number of times docker has mounted a volume if the plugin wishes to free resources for a volume when no containers are consuming a volume. One such resource managed by the plugin is the number of volumes attached to a VM (more details below).</p>

<p>A plugin’s lifecycle includes.</p>

<ol>
  <li>Install</li>
  <li>Uninstall</li>
  <li>Stop</li>
  <li>Start</li>
  <li>Recover from a VM crash</li>
</ol>

<h2 id="plugin-lifecycle-and-expected-behavior">Plugin lifecycle and expected behavior</h2>

<p>[Docker recommends that the docker engine should be started after the plugin] (https://docs.docker.com/engine/extend/plugin_api/)</p>

<p>Note: Upgrade of the plugin is done as an uninstall of the older version and an install of the newer version.</p>

<ol>
  <li>Install: If it is the first install Docker can be running while the plugin is installed. During installs that are part of an upgrade, the admin must insure that docker is stopped and is started after the plugin starts up.</li>
  <li>Uninstall: During uninstall docker should be stopped. Before uninstall, make sure no containers still use the VMDK volumes, stop docker engine, and then uninstall the plugin. Docker will generate timeouts on docker start if there are still VMDK volumes after the plugin is uninstalled.</li>
  <li>Stop: Docker should be stopped before stopping the plugin. [Docker’s documentation] (https://docs.docker.com/engine/extend/plugin_api/)</li>
  <li>Start: The plugin must start before docker. <a href="https://docs.docker.com/engine/extend/plugin_api/">Docker’s documentation</a></li>
  <li>Crash: The init system will start the plugin before docker. The plugin will gracefully clean up volumes that are no longer referenced from any container.</li>
</ol>

<h2 id="ref-counting">Ref Counting.</h2>

<p>The following are related to the internal details for the plugin. This is not customer facing.</p>

<p>Ref Counting for the volume plugin is needed to know when it is safe to umount and detach a volume.</p>

<p>Volume plugins need to maintain a refcount for each volume, increasing the ref count on every mount and decrementing it on unmount. When the count is 0 the plugin is free to unmount the volume and free up resources (Detach the volume from the VM).</p>

<h3 id="possible-states">Possible states</h3>
<div class="highlighter-rouge"><pre class="highlight"><code>0. Init         : Volume exists but is not attached to any VM.
1. Attached     : Volume is attached to the VM but the FS is not mounted.
2. Mounted      : Volume FS is mounted but no container is using it.
3. InUse        : Volume FS is mounted and one or more containers is using it.
</code></pre>
</div>

<p>The plugin initiates state changes for the states of the volume, and only allows correct transitions.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>State Transitions       # RefCount Change
-----------------------------------------
Init 	 -&gt; Attached    # RefCount 0 -&gt; 0
Attached -&gt; Init        # RefCount 0 -&gt; 0
Attached -&gt; Mounted     # RefCount 0 -&gt; 0
Mounted  -&gt; Attached    # RefCount 1 -&gt; 0
Mounted  -&gt; InUse       # RefCount 0 -&gt; 1
InUse    -&gt; Mounted     # RefCount 1 -&gt; 0
InUse 	 -&gt; InUse       # RefCount++
</code></pre>
</div>

<h3 id="possible-failures-and-impact-on-volume-states">Possible failures and impact on volume states</h3>

<ul>
  <li>Docker engine crashes: Docker has not sent any unmount request to the plugin.
<code class="highlighter-rouge">
States: Volumes are either in Init or in Mounted state. 
Recovery: Mounted state needs recovery.
</code>
. Plugin crashes (Plugin accidentally restarted is considered a crash, install and upgrade require docker to be stopped, as mentioned above).
 <code class="highlighter-rouge">
States: Volumes can be in any state and plugin needs to rebuild volume state. 
Recovery: The end goal is to insure volumes are in Init, or InUse.
</code></li>
  <li>VM Crashes and starts up: Docker has not consumed any volume and plugin has no refcount.
<code class="highlighter-rouge">
States: Volumes can be in Init or Attached state. 
Recovery: In the absence of docker engine consuming volumes all volumes need to return to Init state.
</code></li>
</ul>

<p>Note: The manual/automated stopping and starting of docker covers the installation and upgrade case.</p>

<h1 id="current-issues-with-docker">Current issues with Docker</h1>

<h2 id="bugs">Bugs</h2>
<p>There are bugs in the existing implementation for sending unmount requests. https://github.com/docker/docker/issues/22564</p>

  

    <div class="tags">
        
    </div>

    

</div>



<footer>
            <div class="row">
                <div class="col-lg-12 footer">
               &copy;2017 VMWare. All rights reserved. <br />
 Site last generated: Sep 7, 2017 <br />
<p><img src="images/company_logo.png" alt="Company logo"/></p>
                </div>
            </div>
</footer>


    </div>
    <!-- /.row -->
</div>
<!-- /.container -->
    </div>

</body>

</html>